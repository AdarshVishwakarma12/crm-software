<!-- Extend from base.html  -->
{% extends 'featuredApp/base.html' %}


<!-- Loading CSS files from static (path defined at settings.py)-->
{% load static %}


<!-- As we are loading crispy form Hence Import crispy_forms_tags -->
{% load crispy_forms_tags %}


<!-- A nice title -->
{% block titleBlock %} 
	<title> Manage-Access </title>
{% endblock titleBlock %}

<!-- Some extra css property for this specific page -->
{% block addCSSlink %}

	<!-- Specific for pop-up Windows -->
	<link rel="stylesheet" type="text/css" href="{% static 'featuredApp/pop_up.css' %}">

	<style>
	    .permissions-box {
	        cursor: default; /* Prevent pointer or resize cursors on edges */
	    }
	</style>

{% endblock addCSSlink %}

<!-- Main CONTENT GOES HERE -->
{% block contentBody1 %}
	<h2 style="font-weight: bolder;"> Manage Access </h2>

	<hr style="margin: 20px 0;">

	<button class="btn btn-dark" type="button" onclick="openRolesFormPopUp()">Add Roles</button>
{% endblock contentBody1 %}

<!-- A pop-up Window for creating new Client/Contact -->
{% block addPopUp2 %}
	<!-- The Following defined the POP-UP WINDOW for adding new project to the model -->
	<div class="add-pop-up-window" id="roles-pop-up-window-element">

		<span class="close-popup-btn" onclick="closeRolesFormPopUp()">&times;</span>

		<!-- There GOES the form -->
		<!-- Referenced From accounts/register.html -->
		<div style="margin-top: 20px;" class="content-section">
			<!-- Added enctype - cause we need file to be loaded -->
			<form method="post">
			    {% csrf_token %}
			    
			    <h3>Create New Role</h3>
			    <p class="text-muted">Define a new role and set its permissions.</p>

			    <div class="mb-3">
			        <label for="{{ form.name.id_for_label }}" class="form-label">Role Name</label>
			        {{ formA.name }}
			    </div>

			    <h5>Contacts</h5>
				<div class="border rounded p-2 mb-3 permissions-box">
				    {% for field in formA %}
				        {% if "contact" in field.name %}
				            <div class="form-check form-check-inline">
				                {{ field }}
				                <label class="form-check-label">
				                    {% if "_read_" in field.name %}View
				                    {% elif "can_add_" in field.name %}Create
				                    {% elif "can_edit_" in field.name %}Edit
				                    {% elif "can_delete_" in field.name %}Delete
				                    {% elif "can_permanent_delete_" in field.name %}Permanent Delete
				                    {% endif %}
				                </label>
				            </div>
				        {% endif %}
				    {% endfor %}
				    <small class="text-muted d-block mt-1">Set permissions for managing contacts.</small>
				</div>

				<h5>Project</h5>
				<div class="border rounded p-2 mb-3 permissions-box">
		            <div class="form-check form-check-inline">
				      {{ formA.can_add_project }}
				      <label class="form-check-label">Create</label>
				    </div>
				    <small class="text-muted d-block mt-1">Set permissions for managing projects.</small>
				</div>

				<h5>Tasks</h5>
				<div class="border rounded p-2 mb-3 permissions-box">
				    {% for field in formA %}
				        {% if "tasks" in field.name %}
				            <div class="form-check form-check-inline">
				                {{ field }}
				                <label class="form-check-label">
				                    {% if "_read_" in field.name %}View
				                    {% elif "can_add_" in field.name %}Create
				                    {% elif "can_edit_" in field.name %}Edit
				                    {% elif "can_delete_" in field.name %}Delete
				                    {% elif "can_permanent_delete_" in field.name %}Permanent Delete
				                    {% endif %}
				                </label>
				            </div>
				        {% endif %}
				    {% endfor %}
				    <small class="text-muted d-block mt-1">Set permissions for managing tasks.</small>
				</div>

				<h5>Documents</h5>
				<div class="border rounded p-2 mb-3 permissions-box">
				    {% for field in formA %}
				        {% if "documents" in field.name %}
				            <div class="form-check form-check-inline">
				                {{ field }}
				                <label class="form-check-label">
				                    {% if "_read_" in field.name %}View
				                    {% elif "can_add_" in field.name %}Create
				                    {% elif "can_edit_" in field.name %}Edit
				                    {% elif "can_delete_" in field.name %}Delete
				                    {% elif "can_permanent_delete_" in field.name %}Permanent Delete
				                    {% endif %}
				                </label>
				            </div>
				        {% endif %}
				    {% endfor %}
				    <small class="text-muted d-block mt-1">Set permissions for managing documents.</small>
				</div>
<h5>Project Permissions</h5>
<div class="border rounded p-2 mb-3 permissions-box" id="project-permissions-container">
	<small class="text-muted d-block mt-1">Assign access control for individual projects.</small>
</div>

<button type="button" class="btn btn-outline-primary mb-3" onclick="addProjectPermission()" id="add-project-btn">+ Add Project Permission</button>

<template id="project-permission-template">
<div class="border rounded p-2 mb-3 permission-block">
<div class="mb-2">
<label class="form-label">Select Project</label>
<select class="form-select project-select" name="project">
{% for project in project_queryset %}
<option value="{{ project.id }}">{{ project.name }}</option>
{% endfor %}
</select>
</div>

{% comment "Project permission checkboxes" %}
<div>
{% for field in formA %}
{% if "project" in field.name and not "id" in field.name %}
<div class="form-check form-check-inline">
{{ field }}
<label class="form-check-label">
{% if "_read_" in field.name %}View
{% elif "can_edit_" in field.name %}Edit
{% elif "can_delete_" in field.name %}Delete
{% elif "can_permanent_delete_" in field.name %}Permanent Delete
{% endif %}
</label>
</div>
{% endif %}
{% endfor %}
</div>
{% endcomment %}

<!-- Hardcoded checkboxes for clarity -->
<div class="d-flex flex-wrap gap-3 mt-2">
<div class="form-check form-check-inline">
<input type="checkbox" name="can_read_project" class="form-check-input">
<label class="form-check-label">View</label>
</div>
<div class="form-check form-check-inline">
<input type="checkbox" name="can_edit_project" class="form-check-input">
<label class="form-check-label">Edit</label>
</div>
<div class="form-check form-check-inline">
<input type="checkbox" name="can_delete_project" class="form-check-input">
<label class="form-check-label">Delete</label>
</div>
<div class="form-check form-check-inline">
<input type="checkbox" name="can_permanent_delete_project" class="form-check-input">
<label class="form-check-label">Permanent Delete</label>
</div>
</div>

<button type="button" class="btn btn-sm btn-danger mt-2">Remove</button>
</div>
</template>

<h5>Share Access with Other Users</h5>
<div id="access-permissions-container"></div>

<button type="button" class="btn btn-outline-success mb-3" onclick="addAccessPermission()" id="add-access-btn">+ Share Access</button>

<template id="access-permission-template">
<div class="border rounded p-2 mb-3 access-block">
	<div class="row mb-2">
		<div class="col-md-6">
			<label class="form-label">User Email</label>
			<input type="email" name="shared_with_emails" class="form-control shared-email" placeholder="user@example.com" required>
		</div>
	</div>
	<!-- <div class="col-md-1 d-flex align-items-end"> -->
		<button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.access-block').remove()">Remove</button>
	<!-- </div> -->
</div>
</template>

<small class="text-muted d-block mt-1">Share data access by assigning roles to user emails.</small>


			    <button type="submit" class="btn btn-dark w-100">Save Role</button>
			</form>
			
		</div>

	</div>

	<!-- This div allow us to close the pop-up if we click outside.. -->
	<div class="popup-overlay" id="popupOverlay2" onclick="closeRolesFormPopUp()"></div>
{% endblock addPopUp2 %}


{% block extraJS %}

	<!-- The script is specific for project pop-up -->
	<script type="text/javascript">
		let rolesPopUp = document.getElementById('roles-pop-up-window-element');
		let tmp = document.getElementById('popupOverlay');
		

		function openRolesFormPopUp() {
			const form = rolesPopUp.querySelector('form');
			form.reset();

			rolesPopUp.classList.add('open-popup');
			tmp.classList.add('active');
		}

		function closeRolesFormPopUp() {
			rolesPopUp.classList.remove('open-popup');
			tmp.classList.remove('active');
		}

		// Close popup on ESC key
		document.addEventListener('keydown', function(event) {
			if (event.key === 'Escape') {
				closeRolesFormPopUp();
			}
		});

const usedProjects = new Set();

function addProjectPermission() {
const template = document.getElementById('project-permission-template');
const clone = template.content.cloneNode(true);
const projectSelect = clone.querySelector('.project-select');

// Remove already selected projects
const options = [...projectSelect.options];
options.forEach(opt => {
if (usedProjects.has(opt.value)) {
opt.remove();
}
});

if (projectSelect.options.length === 0) {
alert("All projects have already been assigned permissions.");
return;
}

projectSelect.addEventListener('change', function () {
usedProjects.add(this.value);
});

// Track selected project
let selectedValue = projectSelect.value;
usedProjects.add(selectedValue);

// Listen for selection change (to keep usedProjects in sync)
projectSelect.addEventListener('change', function () {
usedProjects.delete(selectedValue); // old
selectedValue = this.value;
usedProjects.add(selectedValue); // new
});

// Handle Remove
const removeButton = clone.querySelector('.btn-danger');
removeButton.addEventListener('click', function () {
usedProjects.delete(selectedValue);
this.closest('.permission-block').remove();
});

// Add first selected project to usedProjects
usedProjects.add(projectSelect.value);

document.getElementById('project-permissions-container').appendChild(clone);
}

const usedEmails = new Set();

function addAccessPermission() {
const template = document.getElementById('access-permission-template');
const clone = template.content.cloneNode(true);
const emailInput = clone.querySelector('.shared-email');
const removeBtn = clone.querySelector('.btn-danger');

emailInput.addEventListener('change', function () {
const email = this.value.trim().toLowerCase();
if (usedEmails.has(email)) {
alert("This email has already been added.");
this.value = '';
return;
}
usedEmails.add(email);
});

removeBtn.addEventListener('click', function () {
const email = emailInput.value.trim().toLowerCase();
usedEmails.delete(email);
this.closest('.access-block').remove();
});

document.getElementById('access-permissions-container').appendChild(clone);
}

	</script>
{% endblock extraJS %}




